*** PackageManagerService.smali	2016-01-12 21:05:58.636766991 +0800
--- PackageManagerService.smali	2016-01-12 21:04:58.043556637 +0800
***************
*** 15939,15944 ****
  
      .restart local p1    # "pkg":Landroid/content/pm/PackageParser$Package;
      :cond_1
      and-int/lit8 v3, p2, 0x1
  
      if-eqz v3, :cond_2
--- 16001,16025 ----
  
      .restart local p1    # "pkg":Landroid/content/pm/PackageParser$Package;
      :cond_1
+     const-string v3, "install"
+ 
+     move-object/from16 v0, p0
+ 
+     move-object/from16 v1, p1
+ 
+     move-object/from16 v2, v58
+ 
+     invoke-direct {v0, v1, v2, v3}, Lcom/android/server/pm/PackageManagerService;->tryIgnorePackage(Landroid/content/pm/PackageParser$Package;Ljava/io/File;Ljava/lang/String;)Z
+ 
+     move-result v3
+ 
+     if-eqz v3, :cond_miui_20
+ 
+     const/16 p1, 0x0
+ 
+     return-object p1
+ 
+     :cond_miui_20
      and-int/lit8 v3, p2, 0x1
  
      if-eqz v3, :cond_2
***************
*** 16395,16405 ****
  
      and-int/lit8 v3, p2, 0x40
  
      if-nez v3, :cond_b
  
      const/4 v3, 0x0
  
-     :try_start_2
      move-object/from16 v0, p0
  
      move-object/from16 v1, p1
--- 16476,16497 ----
  
      and-int/lit8 v3, p2, 0x40
  
+     if-eqz v3, :cond_miui_0
+ 
+     move/from16 v0, p3
+ 
+     and-int/lit16 v3, v0, 0x100
+ 
      if-nez v3, :cond_b
  
+     :try_start_2
+     sget-boolean v3, Landroid/os/Build;->IS_DEBUGGABLE:Z
+ 
+     if-eqz v3, :cond_b
+ 
+     :cond_miui_0
      const/4 v3, 0x0
  
      move-object/from16 v0, p0
  
      move-object/from16 v1, p1
***************
*** 21470,21475 ****
      return-object v21
  
      :cond_1
      const/4 v5, 0x0
  
      .local v5, "ps":Lcom/android/server/pm/PackageSetting;
--- 21575,21597 ----
      return-object v21
  
      :cond_1
+     const-string v3, "boot scanning"
+ 
+     move-object/from16 v0, p0
+ 
+     move-object/from16 v1, p1
+ 
+     invoke-direct {v0, v6, v1, v3}, Lcom/android/server/pm/PackageManagerService;->tryIgnorePackage(Landroid/content/pm/PackageParser$Package;Ljava/io/File;Ljava/lang/String;)Z
+ 
+     move-result v3
+ 
+     if-eqz v3, :cond_miui_20
+ 
+     const/16 v3, 0x0
+ 
+     return-object v3
+ 
+     :cond_miui_20
      const/4 v5, 0x0
  
      .local v5, "ps":Lcom/android/server/pm/PackageSetting;
***************
*** 28109,28118 ****
      :try_end_0
      .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_0
  
      :goto_0
      return-void
  
      :cond_1
      iget-object v7, p0, Lcom/android/server/pm/PackageManagerService;->mHandler:Lcom/android/server/pm/PackageManagerService$PackageHandler;
  
      new-instance v0, Lcom/android/server/pm/PackageManagerService$7;
--- 28361,28377 ----
      :try_end_0
      .catch Landroid/os/RemoteException; {:try_start_0 .. :try_end_0} :catch_0
  
+     :cond_miui_0
      :goto_0
      return-void
  
      :cond_1
+     invoke-direct {p0, p1, p2}, Lcom/android/server/pm/MiuiPackageManagerService;->protectAppFromDeleting(Lcom/android/server/pm/PackageManagerService;Ljava/lang/String;Landroid/content/pm/IPackageDeleteObserver;)Z
+ 
+     move-result v0
+ 
+     if-nez v0, :cond_miui_0
+ 
      iget-object v7, p0, Lcom/android/server/pm/PackageManagerService;->mHandler:Lcom/android/server/pm/PackageManagerService$PackageHandler;
  
      new-instance v0, Lcom/android/server/pm/PackageManagerService$7;
***************
*** 34876,34881 ****
      .param p6, "encryptionParams"    # Landroid/content/pm/ContainerEncryptionParams;
  
      .prologue
      iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
  
      const-string v2, "android.permission.INSTALL_PACKAGES"
--- 35135,35175 ----
      .param p6, "encryptionParams"    # Landroid/content/pm/ContainerEncryptionParams;
  
      .prologue
+     if-nez p1, :cond_miui_0
+ 
+     const-string v1, "PackageManager"
+ 
+     new-instance v2, Ljava/lang/StringBuilder;
+ 
+     invoke-direct {v2}, Ljava/lang/StringBuilder;-><init>()V
+ 
+     const-string v3, "The uri of package "
+ 
+     invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+ 
+     move-result-object v2
+ 
+     move-object/from16 v0, p4
+ 
+     invoke-virtual {v2, v0}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+ 
+     move-result-object v2
+ 
+     const-string v3, " is null"
+ 
+     invoke-virtual {v2, v3}, Ljava/lang/StringBuilder;->append(Ljava/lang/String;)Ljava/lang/StringBuilder;
+ 
+     move-result-object v2
+ 
+     invoke-virtual {v2}, Ljava/lang/StringBuilder;->toString()Ljava/lang/String;
+ 
+     move-result-object v2
+ 
+     invoke-static {v1, v2}, Landroid/util/Slog;->e(Ljava/lang/String;Ljava/lang/String;)I
+ 
+     return-void
+ 
+     :cond_miui_0
      iget-object v1, p0, Lcom/android/server/pm/PackageManagerService;->mContext:Landroid/content/Context;
  
      const-string v2, "android.permission.INSTALL_PACKAGES"
